name: ðŸ” DemonstraÃ§Ã£o de Secrets

on:
  workflow_dispatch:  # Apenas execuÃ§Ã£o manual para este exemplo
    inputs:
      ambiente:
        description: 'Escolha o ambiente'
        required: true
        default: 'desenvolvimento'
        type: choice
        options:
          - desenvolvimento
          - homologacao
          - producao
  push:
    branches: [main]  # Executa em push para a branch main
    paths:
      - .github/workflows/secrets-demo.yml  # Apenas se este arquivo for modificado

jobs:
  demonstrar-secrets:
    name: "ðŸ”‘ Trabalhando com Secrets"
    runs-on: ubuntu-latest
    
    # Definir variÃ¡veis de ambiente baseadas em secrets
    env:
      # Secrets que vocÃª vai criar no GitHub
      API_KEY: ${{ secrets.API_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      # VariÃ¡veis pÃºblicas (nÃ£o sensÃ­veis)
      AMBIENTE: ${{ github.event.inputs.ambiente }}
      NODE_ENV: production
    
    steps:
      - name: "ðŸ“¥ Checkout do cÃ³digo"
        uses: actions/checkout@v4
        
      - name: "âœ… Verificar se secrets estÃ£o configurados"
        run: |
          echo "ðŸ” Verificando secrets..."
          
          # Verificar se secrets existem (sem mostrar o valor!)
          if [ -z "$API_KEY" ]; then
            echo "Secret API_KEY nÃ£o estÃ¡ configurado"
          else
            echo "âœ… Secret API_KEY estÃ¡ configurado"
            echo "ðŸ”¹ Tamanho: ${#API_KEY} caracteres"
          fi
          
          if [ -z "$DATABASE_URL" ]; then
            echo "âŒ Secret DATABASE_URL nÃ£o estÃ¡ configurado"
          else
            echo "âœ… Secret DATABASE_URL estÃ¡ configurado"
            echo "ðŸ”¹ ComeÃ§a com: ${DATABASE_URL:0:10}..."
          fi
          
      - name: "ðŸŒ Mostrar variÃ¡veis de ambiente pÃºblicas"
        run: |
          echo "ðŸ“‹ InformaÃ§Ãµes do ambiente:"
          echo "ðŸ·ï¸ Ambiente selecionado: $AMBIENTE"
          echo "âš™ï¸ NODE_ENV: $NODE_ENV"
          echo "ðŸ‘¤ Executado por: ${{ github.actor }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          
      - name: "ðŸš« NUNCA faÃ§a isso - Exemplo de erro de seguranÃ§a"
        run: |
          echo "âŒ NUNCA faÃ§a echo de secrets diretamente:"
          echo "# echo \"API_KEY: \$API_KEY\"  â† ISSO Ã‰ PERIGOSO!"
          echo "# echo \"DATABASE_URL: \$DATABASE_URL\"  â† NUNCA FAÃ‡A ISSO!"
          echo ""
          echo "âœ… GitHub Actions automaticamente esconde secrets nos logs"
          echo "âœ… Mas Ã© melhor nem tentar imprimi-los"
          
      - name: "âœ… Forma correta de usar secrets"
        run: |
          echo "ðŸ’¡ Formas corretas de usar secrets:"
          echo ""
          echo "1ï¸âƒ£ Passar para aplicaÃ§Ãµes:"
          echo "   export API_KEY=\$API_KEY"
          echo "   ./minha-aplicacao  # A aplicaÃ§Ã£o lÃª a variÃ¡vel"
          echo ""
          echo "2ï¸âƒ£ Usar em comandos (sem imprimir):"
          echo "   curl -H \"Authorization: Bearer \$API_KEY\" https://api.exemplo.com"
          echo ""
          echo "3ï¸âƒ£ Criar arquivos de configuraÃ§Ã£o:"
          echo "   echo \"api_key=\$API_KEY\" > config.env"
          
      - name: "ðŸ”§ SimulaÃ§Ã£o de uso prÃ¡tico"
        run: |
          echo "ðŸš€ Simulando deploy com secrets..."
          
          # Simular criaÃ§Ã£o de arquivo de configuraÃ§Ã£o
          cat > app.config << EOF
          [database]
          url=${DATABASE_URL:-postgresql://localhost:5432/app}
          
          [api]
          key=${API_KEY:-demo-key}
          environment=${AMBIENTE}
          EOF
          
          echo "âœ… Arquivo de configuraÃ§Ã£o criado!"
          echo "ðŸ“„ ConteÃºdo (com valores mascarados):"
          sed 's/key=.*/key=***HIDDEN***/' app.config
          
      - name: "ðŸŽ¯ Diferentes tipos de secrets"
        env:
          # Usando diferentes secrets para diferentes propÃ³sitos
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Token padrÃ£o do GitHub
          CUSTOM_TOKEN: ${{ secrets.CUSTOM_TOKEN }}   # Seu token personalizado
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }} # Webhook do Slack
        run: |
          echo "ðŸ“š Tipos de secrets comuns:"
          echo ""
          echo "ðŸ”¹ GITHUB_TOKEN: Sempre disponÃ­vel automaticamente"
          if [ -n "$GITHUB_TOKEN" ]; then
            echo "  âœ… Configurado (${#GITHUB_TOKEN} chars)"
          fi
          
          echo "ðŸ”¹ CUSTOM_TOKEN: Token personalizado para APIs"
          if [ -n "$CUSTOM_TOKEN" ]; then
            echo "  âœ… Configurado"
          else
            echo "  âŒ NÃ£o configurado (opcional)"
          fi
          
          echo "ðŸ”¹ SLACK_WEBHOOK: Para notificaÃ§Ãµes"
          if [ -n "$SLACK_WEBHOOK" ]; then
            echo "  âœ… Configurado"
          else
            echo "  âŒ NÃ£o configurado (opcional)"
          fi
          
  demonstrar-condicoes:
    name: "ðŸŽ›ï¸ Secrets e CondiÃ§Ãµes"
    runs-on: ubuntu-latest
    # Este job sÃ³ executa se estivermos em produÃ§Ã£o
    if: github.event.inputs.ambiente == 'producao'
    
    steps:
      - name: "âš ï¸ Ambiente de produÃ§Ã£o detectado"
        run: |
          echo "ðŸš¨ ATENÃ‡ÃƒO: Executando em ambiente de PRODUÃ‡ÃƒO!"
          echo "ðŸ”’ VerificaÃ§Ãµes de seguranÃ§a extras ativadas"
          echo "ðŸ“§ NotificaÃ§Ãµes serÃ£o enviadas para administradores"
          
      - name: "ðŸ›¡ï¸ VerificaÃ§Ãµes de seguranÃ§a"
        env:
          PROD_API_KEY: ${{ secrets.PROD_API_KEY }}
        run: |
          echo "ðŸ” Executando verificaÃ§Ãµes de produÃ§Ã£o..."
          
          if [ -z "$PROD_API_KEY" ]; then
            echo "âŒ ERRO: PROD_API_KEY nÃ£o configurado!"
            echo "ðŸš« Deploy em produÃ§Ã£o cancelado por seguranÃ§a"
            exit 1
          else
            echo "âœ… Chave de produÃ§Ã£o verificada"
            echo "ðŸŽ¯ Pronto para deploy em produÃ§Ã£o"
          fi